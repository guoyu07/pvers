#! /usr/bin/env bash

output=$(php -v 2>/dev/null);
if [ ! $1 ]; then
    echo "You MUST provided the PHP version first!";
    exit 1;
elif [ ! -z "$output" ]; then
    echo "PHP interpreter is already installed in system!";
    exit 1;exit 0
else
    # Options
    case "$1" in
        "-h" | "--help" )
            printf "Usage: pvers php-version-number\nExample:\n\$ pvers 5.6.6\n"
            exit 0
        ;;
        "-v" | "--version" )
            echo "PHP version manager v0.1"
            exit 0
        ;;
    esac

    # @todo: put some check here
    version=$1;

    echo "Downloading...";

    basedir="/usr/share/pvers/"$version;
    if [ -d $basedir ]; then
        mkdir -p `echo $basedir`;
    fi

    cd $basedir;
    archive=$(echo "php-"$version".tar.bz2");
    echo "http://ru2.php.net/get/"$archive"/from/this/mirror";
    wget -q $(echo "http://ru2.php.net/get/"$archive"/from/this/mirror");

    echo "Extracting...";

    mv mirror $(echo $archive);
    tar xjf $(echo $archive);
    mv $(echo "php-"$version) src;
    rm $(echo $archive);

    echo "Configuring...";
    # compile_options=("--with-openssl" "--enable-bcmath" "--enable-fpm" "--with-openssl" "--with-curl" "--enable-mbstring" "--with-mysqli" "--with-pdo-mysql" "--with-libedit" "--enable-soap" "--enable-sockets");

    cd "src";
    builddir=$(echo $basedir"/build");
    mkdir -p $builddir;
    compile_options=("--prefix="$builddir" --with-openssl --enable-bcmath --enable-fpm --with-openssl --with-curl --enable-mbstring --with-mysqli --with-pdo-mysql --with-libedit --enable-soap --enable-sockets");
    ./configure $compile_options;
    
    echo "Compiling...";
    make clean && make && make install;

    echo "Successfully installed!";
    exit 0;
fi